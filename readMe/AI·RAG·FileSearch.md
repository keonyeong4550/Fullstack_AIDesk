

# 플로우 차트
![Image](https://github.com/user-attachments/assets/c40cf959-e03d-4b16-a38f-3feb201a6f47)


## 🛠 트러블 슈팅 (AI · RAG Search Flow)

본 항목은 RAG(Retrieval-Augmented Generation) 기반 검색 및  
AI 응답 생성 흐름을 기준으로 발생한 문제와 해결 과정을 정리한 문서입니다.

---

### 1️⃣ 검색 요청은 정상이나 결과가 반환되지 않는 문제

**문제 현상**  
- 검색 API는 정상 응답
- 검색 결과가 0건으로 반환됨

**원인 분석**  
- 검색 대상 문서가 임베딩(Vector) 생성 이전 상태
- 플로우 상 `Query → Retriever → Vector Store` 단계에서  
  검색 대상 조건 불일치

**해결 방법**  
- 검색 대상 문서를 `indexed=true` 상태로 명확히 분리
- 인덱싱 완료 문서만 Retriever가 조회하도록 제한

**결과**  
- 검색 결과 정상 반환

---

### 2️⃣ 검색 결과는 존재하지만 관련도가 낮은 문제

**문제 현상**  
- 검색 결과는 반환되나 질문과 관련성이 낮음

**원인 분석**  
- Query 임베딩 품질이 낮거나 질문이 모호함
- 플로우 상 TopK 값이 작아 핵심 문서 누락

**해결 방법**  
- Query Rewriting을 통해 검색 질의 명확화
- TopK 확장 후 재정렬(Rerank) 적용

**결과**  
- 검색 정확도 및 문서 적합도 향상

---

### 3️⃣ 검색 결과가 매 요청마다 달라지는 문제

**문제 현상**  
- 동일한 질문임에도 검색 결과 순서가 변함

**원인 분석**  
- Vector 유사도 점수 동률 시 정렬 기준 부재
- 비결정적 검색 결과가 LLM 입력에 영향

**해결 방법**  
- 점수 동률 시 문서 ID 기준 정렬 적용
- Retriever 결과를 deterministic 하게 고정

**결과**  
- 재현 가능한 검색 결과 확보

---

### 4️⃣ 검색 결과가 AI 응답에 제대로 반영되지 않는 문제

**문제 현상**  
- 검색 결과는 있으나 AI 응답이 이를 충분히 반영하지 않음

**원인 분석**  
- 플로우 상 `Retriever → Context Builder → LLM` 단계에서  
  컨텍스트 길이 제한으로 일부 문서가 제외됨

**해결 방법**  
- 검색 결과를 중요도 기준으로 선별
- 컨텍스트 구성 규칙을 명시적으로 정의

**결과**  
- 검색 기반 AI 응답 일관성 확보

---

### 5️⃣ AI가 문서에 없는 내용을 생성하는 문제

**문제 현상**  
- 검색된 문서에 없는 내용을 AI가 단정적으로 응답

**원인 분석**  
- 근거 부족 상태에서도 응답 생성을 허용
- “모르면 모른다” 정책 부재

**해결 방법**  
- 최소 인용 기준 도입
- 근거 부족 시 추가 질문 또는 응답 제한

**결과**  
- AI 환각(Hallucination) 감소
- 신뢰 가능한 응답 품질 확보

---

### 6️⃣ 권한 없는 문서가 검색 결과에 포함되는 문제

**문제 현상**  
- 사용자 권한 범위를 벗어난 문서가 검색됨

**원인 분석**  
- Vector 검색 단계에서 권한 필터 누락
- 인덱스에 ACL 메타데이터 미반영

**해결 방법**  
- 문서/Chunk 단위로 권한 메타데이터 저장
- Retriever 단계에서 ACL 필터 선적용

**결과**  
- 검색 및 AI 응답 단계에서 정보 노출 차단

---

### 7️⃣ 검색·AI 응답 성능이 점진적으로 저하되는 문제

**문제 현상**  
- 문서 수 증가에 따라 검색 지연 발생
- AI 응답 생성 시간이 증가

**원인 분석**  
- 검색 범위 과도
- 불필요한 반복 검색 및 LLM 호출

**해결 방법**  
- 메타데이터 기반 검색 범위 축소
- Query Embedding 캐싱 적용

**결과**  
- 응답 속도 개선
- 시스템 비용 안정화

---

