# AI 메시지 처리 기능 추가 - 기존 코드 수정 사유

## 개요

기존 채팅 시스템에 AI 메시지 처리 기능을 선택적으로 추가하기 위해 일부 코드 수정이 필요했습니다.
기존 채팅 로직의 핵심 구조는 유지하면서, AI 기능을 별도 컴포넌트로 분리하여 통합했습니다.

## 수정한 파일 목록

### 1. DTO 수정

#### `ChatMessageCreateDTO.java`
- **추가 필드**: `aiEnabled` (Boolean)
- **수정 사유**: 
  - 프론트엔드에서 AI 메시지 처리 ON/OFF 의도를 서버로 전달하기 위해 필요
  - 기존 DTO에 필드 추가 없이는 프론트엔드의 AI 사용 의도를 서버에서 알 수 없음
  - 기존 필드 구조를 유지하면서 선택적 필드로 추가하여 하위 호환성 유지

#### `ChatMessageDTO.java`
- **추가 필드**: `ticketTrigger` (Boolean)
- **수정 사유**:
  - AI 처리 과정에서 감지된 티켓 생성 문맥을 프론트엔드로 전달하기 위해 필요
  - 프론트엔드에서 티켓 작성 모달을 띄우는 트리거로 사용
  - 기존 응답 구조를 변경하지 않고 추가 필드로 확장

### 2. 서비스 레이어 수정

#### `ChatMessageServiceImpl.java`
- **수정 내용**: `sendMessage` 메서드에 AI 처리 로직 추가
- **수정 사유**:
  - 기존 `sendMessage` 메서드는 메시지를 그대로 저장하는 구조였음
  - AI 처리를 별도 컴포넌트(`AiMessageProcessor`)로 분리했지만, 메시지 저장 전에 AI 처리를 수행해야 함
  - 기존 메서드 구조(채팅방 확인 → 참여자 확인 → messageSeq 생성 → 메시지 저장 → lastMsg 업데이트)는 그대로 유지
  - AI 처리는 메시지 저장 전에 수행하여, 처리된 메시지만 DB에 저장되도록 함
  - 원문 메시지는 AI 처리 후 즉시 참조를 제거하여 메모리에서 제거

## 기존 코드로 불가능했던 기술적 이유

1. **프론트엔드 의도 전달 불가**: 
   - 기존 DTO에는 AI 사용 의도를 전달할 필드가 없었음
   - 프론트엔드의 토글 버튼 상태를 서버로 전달할 방법이 없었음

2. **AI 처리 결과 전달 불가**:
   - 기존 응답 DTO에는 티켓 생성 문맥 감지 결과를 전달할 필드가 없었음
   - 프론트엔드에서 티켓 작성 모달을 띄울 트리거가 없었음

3. **메시지 처리 시점 문제**:
   - AI 처리는 메시지 저장 전에 수행되어야 함 (처리된 메시지만 저장)
   - 기존 `sendMessage` 메서드 내에서 AI 처리를 호출하지 않으면, 별도 서비스로 분리한 AI 컴포넌트를 활용할 수 없음

## 이 프로젝트 맥락에서 더 나은 이유

1. **기존 로직 보존**:
   - `sendMessage` 메서드의 핵심 구조(권한 확인, messageSeq 생성, 저장, lastMsg 업데이트)는 그대로 유지
   - AI 처리는 선택적으로 수행되며, AI 기능이 OFF일 때는 기존과 동일하게 동작

2. **하위 호환성 유지**:
   - DTO에 선택적 필드 추가로 기존 클라이언트와의 호환성 유지
   - `aiEnabled`가 null이거나 false이면 기존 로직 그대로 수행

3. **명확한 책임 분리**:
   - AI 처리는 `AiMessageProcessor` 컴포넌트로 분리
   - 서비스 레이어는 AI 처리 결과를 받아서 메시지 저장만 수행
   - AI 처리 실패 시 원문 메시지로 fallback

4. **보안 및 프라이버시**:
   - 원문 메시지는 AI 처리 후 즉시 참조 제거
   - 처리된 메시지만 DB에 저장되어 원문이 남지 않음

## AI 기능 구조

```
ChatController/ChatWebSocketController
    ↓
ChatMessageService.sendMessage()
    ↓
AiMessageProcessor.processMessage()  [별도 컴포넌트]
    ↓
OllamaClient.processMessage()         [별도 컴포넌트]
    ↓
처리된 메시지 반환
    ↓
ChatMessageService.sendMessage() (계속)
    ↓
메시지 저장 (처리된 메시지만)
```

## 참고사항

- AI 기능은 서버 설정(`ai.message.enabled`)과 프론트엔드 요청(`aiEnabled`) 모두 true일 때만 동작
- AI 처리 실패 시 원문 메시지로 fallback
- 원문 메시지는 어디에도 저장되지 않음 (DB, 로그, 캐시 등)
